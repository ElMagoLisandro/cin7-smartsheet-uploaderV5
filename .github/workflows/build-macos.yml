name: Build macOS v5.0

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Build macOS app with PyInstaller
      run: |
        pyinstaller --name "Cin7SmartsheetUploader" \
          --windowed \
          --onefile \
          --hidden-import pandas \
          --hidden-import openpyxl \
          --hidden-import smartsheet \
          --hidden-import tkinter \
          --hidden-import tkinter.scrolledtext \
          --hidden-import tkinter.ttk \
          --collect-all smartsheet \
          --collect-all openpyxl \
          --collect-all pandas \
          cin7_smartsheet_uploader_v5.py
    
    - name: Create App Bundle
      run: |
        mkdir -p "dist/Cin7 Smartsheet Uploader.app/Contents/MacOS"
        mkdir -p "dist/Cin7 Smartsheet Uploader.app/Contents/Resources"
        mv dist/Cin7SmartsheetUploader "dist/Cin7 Smartsheet Uploader.app/Contents/MacOS/"
        
        cat > "dist/Cin7 Smartsheet Uploader.app/Contents/Info.plist" << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CFBundleExecutable</key>
            <string>Cin7SmartsheetUploader</string>
            <key>CFBundleName</key>
            <string>Cin7 Smartsheet Uploader</string>
            <key>CFBundleDisplayName</key>
            <string>Cin7 Smartsheet Uploader v5.0</string>
            <key>CFBundleIdentifier</key>
            <string>com.futuratrailers.cin7uploader</string>
            <key>CFBundleVersion</key>
            <string>5.0.0</string>
            <key>CFBundleShortVersionString</key>
            <string>5.0.0</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>NSHighResolutionCapable</key>
            <true/>
        </dict>
        </plist>
        EOF
        
        chmod -R 755 "dist/Cin7 Smartsheet Uploader.app"
    
    - name: Create DMG
      run: |
        hdiutil create -volname "Cin7 Uploader v5.0" \
          -srcfolder "dist/Cin7 Smartsheet Uploader.app" \
          -ov -format UDZO \
          "Cin7-Smartsheet-Uploader-v5.0.dmg"
    
    - name: Upload DMG
      uses: actions/upload-artifact@v4
      with:
        name: Cin7-Smartsheet-Uploader-v5.0-DMG
        path: Cin7-Smartsheet-Uploader-v5.0.dmg
        retention-days: 90
